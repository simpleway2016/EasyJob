<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="/css/flex.css" rel="stylesheet" type="text/css" />
    <script src="/js/Editor.js" type="text/javascript"></script>
    <script src="/js/EditorControls.js" type="text/javascript"></script>
    <script src="/js/PropertyDialog.js" type="text/javascript"></script>
    <script src="/js/jscolor.min.js" type="text/javascript"></script>
    <script src="/js/FileBrowser.js" type="text/javascript"></script>
    <script src="/js/UndoManager.js" type="text/javascript"></script>
    <script src="/WayScriptRemoting" type="text/javascript"></script>
    <style>
        body{
            padding:0;
            margin:0;
            width:100%;
            height:100%;
        }
        .toolboxItem {
            width: 24px;
            height: 24px;
            box-sizing:border-box;
            margin-left: 5px;
            margin-top: 4px;
            float: left;
            background-repeat:no-repeat;
            background-position:center;
        }
        .toolboxItem[selected='1'] {
            border: 1px solid #b8b7b5;
            background-color:#f6d39c;
        }
        .toolboxItem img{
            width:16px;
            height:16px;
            margin-left:4px;
            margin-top:4px;
        }
        .propertyDialog{
            border:1px solid #808080;
            border-radius:5px;
            background-color:#e8e7e3;
            font-size:12px;
            line-height:25px;
        }
        .FileBrowser
        {
            border:5px solid #808080;
            background-color:white;
            width:60%;
            height:80%;
            position:absolute;
        }
        .FileBrowserBg{
            background-color:rgba(0,0,0,0.3);
          
        }
        .FileBrowserItem {
            width: 100px;
            font-size: 12px;
            margin-left: 5px;
            margin-top: 5px;
            cursor: pointer;
        }
        .FileBrowserFolderMenu
        {
            border:1px solid #808080;
            border-radius:3px;
            background-color:#e8e7e3;
            position:absolute;
        }
        .FileBrowserFolderMenu div{
            font-size:14px;
            padding:5px;
        }
    </style>
</head>
<body style="overflow:hidden;" oncontextmenu="return false;">
    <div class="display-flex flex-direction-column" style="position:absolute;width:100%;height:100%;">
        <div style="background-color:#e8e7e3;height:36px;">
            <div id="btnSetting" class="toolboxItem" onclick="editor.setting(arguments[0]);" style="background-image:url(/images/toolbox/setting.png);">
            </div>
            <div class="toolboxItem" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/line.png);" _type="ToolBox_Line">
            </div>
            <div class="toolboxItem" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/circle.png);" _type="ToolBox_Circle">
            </div>
            <div class="toolboxItem" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/rect.png);" _type="ToolBox_Rect">
            </div>
            <div class="toolboxItem" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/ellipse.png);" _type="ToolBox_Ellipse">
            </div>
            <div class="toolboxItem" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/text.png);" _type="ToolBox_Text">
            </div>
            <div class="toolboxItem" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/img.png);" _type="ToolBox_Image">
            </div>
            <div class="toolboxItem" title="动态值圆柱" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/cylinder.png);" _type="ToolBox_Cylinder">
            </div>
            <div class="toolboxItem" title="趋势图" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/trend.png);" _type="ToolBox_Trend">
            </div>
            <div class="toolboxItem" title="点击区域" onclick="toolboxClick(this);" style="background-image:url(/images/toolbox/buttonarea.png);" _type="ToolBox_ButtonArea">
            </div>
            <!--<input class="jscolor" value="ab2567">-->
            <div class="toolboxItem" title="撤销" onclick="editor.undo();" style="background-image:url(/images/toolbox/undo.png);margin-left:20px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="重做" onclick="editor.redo();" style="background-image:url(/images/toolbox/redo.png);cursor:pointer;margin-left:0px;">
            </div>
            <div class="toolboxItem" title="删除选定的控件" onclick="editor.delete();" style="background-image:url(/images/toolbox/delete.png);cursor:pointer;margin-left:0px;">
            </div>

            <!--<input class="jscolor" value="ab2567">-->
            <div class="toolboxItem" title="复制" onclick="editor.copy();" style="background-image:url(/images/toolbox/copy.png);margin-left:20px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="粘贴" onclick="editor.paste();" style="background-image:url(/images/toolbox/paste.png);cursor:pointer;margin-left:0px;">
            </div>

            <div class="toolboxItem" title="测试开始" onclick="startTest();" style="background-image:url(/images/toolbox/copy.png);margin-left:20px;cursor:pointer;">
            </div>

            <div class="toolboxItem" title="左对齐" onclick="editor.alignLeft();" style="background-image:url(/images/toolbox/alignleft.png);margin-left:20px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="右对齐" onclick="editor.alignRight();" style="background-image:url(/images/toolbox/alignright.png);cursor:pointer;margin-left:0px;">
            </div>
            <div class="toolboxItem" title="上对齐" onclick="editor.alignTop();" style="background-image:url(/images/toolbox/aligntop.png);margin-left:0px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="下对齐" onclick="editor.alignBottom();" style="background-image:url(/images/toolbox/alignbottom.png);cursor:pointer;margin-left:0px;">
            </div>
            <div class="toolboxItem" title="水平等距离" onclick="editor.hSpacing();" style="background-image:url(/images/toolbox/hspacing.png);margin-left:0px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="垂直等距离" onclick="editor.vSpacing();" style="background-image:url(/images/toolbox/vspacing.png);cursor:pointer;margin-left:0px;">
            </div>
            <div class="toolboxItem" title="水平居中对齐" onclick="editor.hCenter();" style="background-image:url(/images/toolbox/hcenter.png);margin-left:0px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="垂直居中对齐" onclick="editor.vCenter();" style="background-image:url(/images/toolbox/vcenter.png);cursor:pointer;margin-left:0px;">
            </div>
            <div class="toolboxItem" title="上移一层" onclick="editor.layerUp();" style="background-image:url(/images/toolbox/layerup.png);margin-left:0px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="下移一层" onclick="editor.layerDown();" style="background-image:url(/images/toolbox/layerdown.png);cursor:pointer;margin-left:0px;">
            </div>
            <div class="toolboxItem" title="移到顶层" onclick="editor.layerFront();" style="background-image:url(/images/toolbox/bringtofront.png);margin-left:0px;cursor:pointer;">
            </div>
            <div class="toolboxItem" title="移到底层" onclick="editor.layerBottom();" style="background-image:url(/images/toolbox/bringtobottom.png);cursor:pointer;margin-left:0px;">
            </div>
        </div>
        <div class="flex-1" id="svgContainer">
        </div>
    </div>

    <div class="FileBrowserFolderMenu" style="visibility:hidden;z-index:999;min-width:100px;cursor:default;">
        <div onclick="this.parentElement._obj.copy(this.parentElement.ele,this.parentElement._data.id);">复制路径到粘贴板</div>
        <div onclick="this.parentElement._obj.rename(this.parentElement.ele,this.parentElement._data.id);">重命名</div>
        <div onclick="this.parentElement._obj.deleteFile(this.parentElement.ele,this.parentElement._data.id);">删除</div>
    </div>
    
    <script lang="ja">
       
        var lastActiveEle;
        function toolboxClick(ele)
        {
            if (lastActiveEle)
            {
                lastActiveEle.setAttribute("selected", "0");
            }
            ele.setAttribute("selected", "1");
            editor.setCurrentToolBoxItem(ele.getAttribute("_type"));
            lastActiveEle = ele;
        }
        document.body.addEventListener("mousedown", function (e) {
            if (e.button == 2 && lastActiveEle) {
                lastActiveEle.setAttribute("selected", "0");
                lastActiveEle = null;
                editor.setCurrentToolBoxItem(null);
            }
        }, false);

        function toolboxDone()
        {
            if (lastActiveEle) {
                lastActiveEle.setAttribute("selected", "0");
                lastActiveEle = null;
                editor.setCurrentToolBoxItem(null);
            }
        }

        

        function copyToClipboard(data) {
            var event = document.createEvent('MessageEvent');
            var origin = window.location.protocol + '//' + window.location.host;
            event.initMessageEvent('copyToClipboard', true, true, data, origin, 1234, window, null);
            document.dispatchEvent(event);
        }

        function loadFinish()
        {
            try {
                var event = document.createEvent('MessageEvent');
                var origin = window.location.protocol + '//' + window.location.host;
                event.initMessageEvent('loadFinish', true, true, "", origin, 1234, window, null);
                document.dispatchEvent(event);
            }
            catch (e)
            {

            }
        }

        function save(name,code,editorScript,controlsScript) {
            var event = document.createEvent('MessageEvent');
            var origin = window.location.protocol + '//' + window.location.host;
            event.initMessageEvent('save', true, true, JSON.stringify({ "name": name,"code":code,"editorScript": editorScript, "controlsScript": controlsScript} ), origin, 1234, window, null);
            document.dispatchEvent(event);
        }
        function watchPointValues(json)
        {
            var event = document.createEvent('MessageEvent');
            var origin = window.location.protocol + '//' + window.location.host;
            event.initMessageEvent('watchPointValues', true, true, json, origin, 1234, window, null);
            document.dispatchEvent(event);
        }
        
       
        function startTest()
        {
            window.devicePoints = [];
            window.devicePoints.push({
                name: "/p/01",
                value: 1,
                max: 200,
                min: 0,
                timeoutNumber: null,
                timeoutValue: null,
            });
            window.devicePoints.push({
                name: "/p/02",
                value: 2,
                max: 200,
                min: 0,
                timeoutNumber: null,
                timeoutValue: null,
            });
            window.devicePoints.push({
                name: "/p/03",
                value: 3,
                max: 200,
                min: 0,
                timeoutNumber: null,
                timeoutValue: null,
            });

            for (var i = 0; i < editor.controls.length; i++) {
                var control = editor.controls[i];
                control.run();
            }

            window.setInterval(function () {
                for (var i = 0; i < window.devicePoints.length; i++) {
                    var devPoint = window.devicePoints[i];
                    var newvalue = GetRandomNum(1, 200);
                    receiveNewValue(devPoint, newvalue);
                }
            }, 1000);
        }

        function receiveNewValue(devPoint,newvalue)
        {
            if (devPoint.value != newvalue)
            {
                if (!devPoint.setValueTime || new Date().getTime() - devPoint.setValueTime > 3000) {
                    //如果是手动设置值，那么3秒内，不会被服务器发送过来的值更新
                    devPoint.value = newvalue;
                    if (devPoint.timeoutNumber)
                    {
                        //既然这里更新点的值，那setTimeout更新的那个就没有必要了
                        clearTimeout(devPoint.timeoutNumber);
                        devPoint.timeoutNumber = null;
                    }                   
                    onPointValueChanged(devPoint);
                }
                else {
                    var interval = new Date().getTime() - devPoint.setValueTime;
                    interval = 3000 - interval;
                    if (interval <= 0)
                        interval = 1;

                    devPoint.timeoutValue = newvalue;
                    if (!devPoint.timeoutNumber) {
                        //设置经过一段时间后，再更新点的值
                        devPoint.timeoutNumber = setTimeout(function () {
                            devPoint.timeoutNumber = null; 
                            if (devPoint.value != devPoint.timeoutValue) {
                                devPoint.value = devPoint.timeoutValue;
                                onPointValueChanged(devPoint);
                            }
                        }, interval);
                    }
                }
            }
            else {
                if (devPoint.timeoutNumber) {
                    //既然服务器新的值和point.value相同，证明上一次设置的setTimeout没有必要运行了
                    clearTimeout(devPoint.timeoutNumber);
                    devPoint.timeoutNumber = null;
                }     
            }
        }

        function GetRandomNum(Min, Max) {
            var Range = Max - Min;
            var Rand = Math.random();
            return (Min + Math.round(Rand * Range));
        }   
        function onPointValueChanged(point)
        {
            for (var i = 0; i < editor.controls.length; i++)
            {
                var control = editor.controls[i];
                if (control.devicePoint == ManyPointDefined || control.devicePoint == point.name)
                {
                    control.onDevicePointValueChanged(point);
                }
            }
        }

        function loadControls(editor)
        {
            var eCtrl;
            //code here
        }


        function initAllDevicePoints()
        {
            var pointNames = [];
            for (var i = 0; i < editor.controls.length; i++)
            {
                var ctrl = editor.controls[i];
                for (var p in ctrl)
                {
                    if (p.indexOf("devicePoint") == 0 && ctrl[p] && ctrl[p].length > 0)
                    {
                        var pointName = ctrl[p];
                        if (pointNames.indexOf(pointName) < 0)
                            pointNames.push(pointName);
                    }
                }
            }

            remoting.server.GetPointDetails(pointNames, function (ret, err) {
                if (err)
                    alert(err);
                else {
                    for (var i = 0; i < ret.length; i++) {
                        var p = ret[i];
                        p.value = 0;
                        p.timeoutNumber = null;
                        p.timeoutValue = null;
                        devicePoints.push(p);
                    }
                    watchPointValues(JSON.stringify(devicePoints));
                }
            });
           
        }

        function onReceiveValueFromServer(point)
        {
            for (var i = 0; i < devicePoints.length; i++) {
                if (devicePoints[i].addr == point.addr) {
                    receiveNewValue(devicePoints[i], point.value);
                    break;
                }
            }
        }

        //进入运行模式
        function run()
        {
            initAllDevicePoints(); 
            for (var i = 0; i < editor.controls.length; i++) {
                var control = editor.controls[i];
                control.run();
            }
        }

        var devicePoints = [];
        var editor;
        var fileBrowser;
        var remoting;
        editor = new Editor("svgContainer");
        fileBrowser = new FileBrowser();
        loadControls(editor);
        loadFinish();
        //把EditorControl关联的点找出来
        remoting = "SunRizServer.Controllers.StudioController".controller();
        run();

        if (editor.name.length == 0)
        {
            btnSetting.click();
        }
    </script>
</body>
</html>