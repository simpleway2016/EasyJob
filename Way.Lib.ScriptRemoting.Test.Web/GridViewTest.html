<!DOCTYPE html>
<html>
<head>
    <script src="scripts/jquery.js" type="text/javascript"></script>
    <script src="scripts/sonic.js" type="text/javascript"></script>
    <script src="scripts/wayscriptremoting.js" type="text/javascript"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
	<meta charset="utf-8" />
    <style>
        td {
        border-right:1px solid blue;
        }
    </style>
</head>
<body style="overflow:hidden;">
    <input type="button" value="rebind" onclick="grid.databind()" />
    <div id="searchDiv">
        caption:<input type="text" _databind="value=@caption"/>TableID:<input type="text" _databind="value=@TableID" /><input type="button" value="search" onclick="goSearch()" />
    </div>
    <div id="div1" style="background-color:#aaaaaa;"></div>
    <div id="grid" style="width:100%;height:280px;-webkit-overflow-scrolling:touch;overflow-y:auto;overflow-x:hidden;">
        <script _for="body" type="text/html">
            <table style="width:100%;border-collapse:collapse;"></table>
        </script>
        <script _for="header" type="text/html">
            <tr>
                <td style="background-color:#aaaaaa;">Name</td>
                <td>caption</td>
                <td>dbType</td>
                <td>TableID</td>
                <td>TableName</td>
            </tr>
        </script>

        <script _for="footer" type="text/html">
            <tr>
                <td style="background-color:#aaaaaa;">footer1</td>
                <td >footer2</td>
                <td>footer3</td>
                <td>f</td>
            </tr>
        </script>

        <script _for="item" type="text/html">
            <tr >
                <td style="background-color:#aaaaaa;" _databind="style.backgroundColor=$Color">
                   <input type="checkbox" _databind="checked=$Selected;"><span onclick="alert(grid.items[{ $ItemIndex }]._status.Selected); ">{$ItemIndex}.{@Name}
                    {$Color}
                    </span> 

                </td>
                <td>{@caption}</td>
                <td>{@dbType}</td>
                <td onclick="edit({ $ItemIndex });">{@TableID}&nbsp;编辑</td>
                <td>{@TableID:DBTable.id:name}</td>
            </tr>
        </script>

        <script _for="item" _match="@Name=='id'" type="text/html">
            <tr style="color:blue;">
                <td style="background-color:#aaaaaa;">
                    {$ItemIndex}.{@Name}
                </td>
                <td>{@caption}</td>
                <td>{@dbType}</td>
                <td>{@TableID}</td>
                <td>{@TableID:DBTable.id:name}</td>
            </tr>
        </script>

        <script _for="item" _mode="edit" type="text/html">
            <tr>
                <td style="background-color:#aaaaaa;">
                    <input type="text" _databind="value=@Name" />
                </td>
                <td>{@caption}</td>
                <td>
                    <input type="text" _databind="value=@dbType" />
                    <input type="button" value="ok" onclick="save({$ItemIndex})" />
                </td>
                <td>{@TableID}</td>
                <td>TableName</td>
            </tr>
        </script>
    </div>
   <div id="tdfooter"></div>
    <div id="hjDiv"></div>
    <div id="totalDiv"></div>

    <div id="editor"></div>

    <!--<script src="WayScriptRemoting" type="text/javascript"></script>-->
    
    <script lang="ja">

        var testPage = WayScriptRemoting.createRemotingController("Way.Lib.ScriptRemoting.Test.TestPage");
        testPage.onmessage = function (e) {
            alert("group msg:" + e);
        }
        testPage.groupName = "g1";
        var grid;

        function onReady()
        {
            grid = new WayGridView("grid", "Way.Lib.ScriptRemoting.Test.TestPage", 10);
            //grid.header = new WayTemplate( '<tr><td>H1</td><td>H2</td></tr>');
            //grid.footer = new WayTemplate('<tr><td>footer1</td><td>F2</td></tr>');
            //{$ItemIndex}代表当前Item的索引号
            grid.datasource = "grid";
            grid.searchModel = WayDataBindHelper.dataBind("searchDiv", {});
            //grid.onItemSizeChanged = function () {
            //    //注意，headertable里面的td不要设置width，width要设置在item里的td
            //    var tableSource = $("#grid1");
            //    var tableHeader = tableSource.prev();
            //    var tableFooter = tableSource.next();
            //    //保持两个table的td同宽
            //    grid.setSameWidthForTables(tableSource, tableHeader);
            //    grid.setSameWidthForTables(tableSource, tableFooter);
            //}

            grid.itemStatusModel = {
                Selected: false,
                onchange: function (model, itemIndex, name, value) {

                    if (name == "Selected") {
                        model.Color = value ? "#cccccc" : "white";
                    }

                }
            };
            grid.onAfterCreateItems = function (total, hasmore) {
                $("#tdfooter").html("记录数：" + (hasmore ? "大于" : "共") + total);
            }
            grid.onDatabind = function () {
                grid.sum(["TableID"], function (data, err) {
                    if (err)
                        alert(err);
                    else {
                        document.getElementById("hjDiv").innerHTML = "合计TableID：" + data.TableID;
                    }
                });

                grid.count(function (data, err) {
                    if (err)
                        alert(err);
                    else {
                        document.getElementById("totalDiv").innerHTML = "总记录数：" + data;
                    }
                });
            }
            grid.databind();
        }
        onReady();
        

        function goSearch()
        {
            grid.search();
        }

     

        function edit(itemIndex) {
            try {
                grid.changeMode(itemIndex, "edit");

            }
            catch (e) {
                alert(e.message);
            }
        }
        function save(editingIndex) {
            try {
                grid.save(editingIndex, function (ret, err) {
                    if (err)
                        alert(err);
                    else {
                        grid.rebindItemFromServer(editingIndex, "");
                       // grid.acceptItemChanged(editingIndex);
                        //grid.changeMode(editingIndex, "");
                    }
                });
               
            }
            catch (e) {
                alert(e.message);
            }
            
        }
        function normal(itemIndex) {
            try {
                grid.changeMode(itemIndex, "");
            }
            catch (e) {
                alert(e.message);
            }
        }
        
    </script>
</body>
</html>
